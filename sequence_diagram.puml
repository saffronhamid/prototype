@startuml
autonumber

actor "Admin" as Admin
actor "New User" as User
participant "API / Invite Controller" as InviteCtrl
participant "API / Auth Controller" as AuthCtrl
database "In-Memory DB" as DB

== Invitation Process ==

Admin -> InviteCtrl: POST /users/invite\n{email, role, projectId}
activate InviteCtrl

InviteCtrl -> DB: Check if projectId exists
InviteCtrl -> DB: Create Invitation (PENDING)
InviteCtrl --> Admin: 201 Created\n{invitationId, message}
deactivate InviteCtrl

note right of Admin
  In a real app, an email would be sent.
  Here, the Admin manually shares the invitationId.
end note

== Acceptance Process ==

User -> AuthCtrl: POST /auth/accept-invitation\n{invitationId, username, password, ...}
activate AuthCtrl

AuthCtrl -> DB: Find Invitation by ID
alt Invitation Valid & PENDING
    AuthCtrl -> DB: Check Username/Email uniqueness
    
    alt Unique
        AuthCtrl -> DB: Create User (Hash Password)
        
        opt Linked Project
            AuthCtrl -> DB: Add User to Project Members
        end
        
        AuthCtrl -> DB: Update Invitation status -> ACCEPTED
        AuthCtrl --> User: 201 Created\n{userId, message}
    else Username/Email Taken
        AuthCtrl --> User: 400 Error
    end
else Invitation Invalid or Used
    AuthCtrl --> User: 404/400 Error
end

deactivate AuthCtrl

@enduml
